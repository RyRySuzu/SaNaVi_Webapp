<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/style_modal.css">
    <!--<script src="¥b//code.jquery.com/jquery-1.10.2.min.js"></script>-->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//code.jquery.com/mobile/1.4.0-rc.1/jquery.mobile-1.4.0-rc.1.min.js"></script>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="js/bootstrap-transition.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
</head>

<body>
    <!-- 音声ファイルの読み込み -->
    <audio id="sound-file" preload="auto">
    <source src="sound/meka_ge_keihou05.mp3" type="audio/mp3">
  </audio>

    <div data-role="page" class="ui-responsive-panel">
        <div data-role="panel" id="panel" data-position="left" data-theme="a" data-display="push">
            <div id="panel_inner_wrap" class="panel_inner_style">

                <div id="intro_step1">
                    <div data-role="header">
                        <h1 data-localize="title.facility">絞り込み</h1>
                    </div>
                    <div data-role="fieldcontain">
                        <form id="checklisttable">
                            <fieldset data-role="controlgroup">
                                <input type="checkbox" data-theme="c" id="cb_gyosen" name="r1" onclick="Gclick()" 　>
                                <label for="cb_gyosen" data-localize="category.att">
                  <img src="img/gyosen.png" width="20" height="20">
                  <i> 漁船</i> </label>

                                <input type="checkbox" data-theme="c" id="cb_ryokyaku" name="r1" onclick="RYOclick()">
                                <label for="cb_ryokyaku" data-localize="category.restaurant">
                  <img src="img/ryokyakusen.png" width="20" height="20">
                  <i> 旅客船</i></label>

                                <input type="checkbox" data-theme="c" id="cb_kamotu" name="r1" onclick="KAclick()">
                                <label for="cb_kamotu" data-localize="category.convenience">
                  <img src="img/kamotusen.png" width="20" height="20">
                  <i> 貨物船</i></label>

                                <input type="checkbox" data-theme="c" id="cb_kousoku" onclick="KOclick()">
                                <label for="cb_kousoku" data-localize="category.toilet">
                  <img src="img/kousokusen.png" width="20" height="20">
                  <i> 高速船</i></label>

                                <input type="checkbox" data-theme="c" id="cb_tannka" onclick="TANclick()" class="area">
                                <label for="cb_tannka" data-localize="category.parking">
                  <img src="img/tannka.png" width="20" height="20">
                  <i> タンカー</i></label>

                                <input type="checkbox" data-theme="c" id="cb_rezya" onclick="REclick()">
                                <label for="cb_rezya" data-localize="category.ATM">
                  <img src="img/rezyasenpng.png" width="20" eight="20">
                  <i> レジャー船</i></label>

                                <input type="checkbox" data-theme="c" id="cb_tag" onclick="TAGclick()">
                                <label for="cb_tag" data-localize="category.tag">
                  <img src="img/tagpilotsen.png" width="20" height="20">
                  <i> タグ　パイロット船</i></label>

                                <input type="checkbox" data-theme="c" id="cb_others" onclick="Yclick()">
                                <label for="cb_others" data-localize="category.others">
                  <img src="img/yet.png" width="20" height="20">
                  <i> ヨット　その他</i></label>

                                <input type="checkbox" data-theme="c" id="cb_minyuryoku" onclick="Mclick()">
                                <label for="cb_minyuryoku" data-localize="category.minyuryoku">
                  <img src="img/minyuryoku.png" width="20" height="20">
                  <i> 未入力</i></label>
                            </fieldset>
                        </form>
                    </div>

                    <div data-role="header">
                        <h1 data-localize="title.keyword">ShipSearch</h1>
                    </div>
                    <div data-role="content">
                        <form name="searchform2" id="searchform2" method="post" action="#">
                            <input id="value1" type="text" name="keywords2" placeholder="他船のidを入力してください" />
                            <button id="button_search" type="button" class="btn btn-primary" data-localize="searchbutton">検索</button>
                            <button id="return_map" type="button" class="btn btn-primary" data-localize="searchbutton" style="display:none">現在位置に移動する</button>
                        </form>
                    </div>
                </div>

                <br/>


                <div id="intro_step3">
                    <div data-role="header">
                        <h1 data-localize="title.keyword">ログイン</h1>
                    </div>
                    <div data-role="content">
                        <p id="login_now" class="lti">ログインしていません</p>
                        <br>
                        <button id="login_start" value="ログイン" type="button" class="btn btn-primary" data-toggle="modal" data-target="#login-modal" data-localize="searchbutton">Login</button>
                        <button id="logout_start" value="ログアウト" type="button" class="btn btn-primary" data-localize="searchbutton">Logout</button>
                    </div>
                </div>


                <div id="intro_step4">
                    <div data-role="header">
                        <h1 data-localize="title.keyword">接近検知機能の切り替え</h1>
                    </div>
                    <div data-role="fieldcontain">
                        <form id="checklisttable">
                            <fieldset data-role="controlgroup">
                                <input type="checkbox" data-theme="c" id="cb_approach" name="r1" onclick="Approachclick()" 　>
                                <label for="cb_approach" data-localize="category.att">
                  <img src="img/gyosen.png" width="20" height="20">
                  <i> 接近検知をオフにする</i> </label>
                            </fieldset>
                        </form>

                    </div>
                </div>

                <div id="intro_step5">
                    <div data-role="header">
                        <h1 data-localize="title.keyword">アカウント作成</h1>
                    </div>
                    <div data-role="content">
                        <br>
                        <button id="register_start" type="button" class="btn btn-primary" data-localize="searchbutton">Create Account</button>
                    </div>
                </div>
                <hr/>
            </div>
        </div>

        <div data-role="content" role="main" id="wrap">
            <div id="map_canvas" class="gmap"></div>
        </div>

        <div data-role="header" id="header_label" class="hidden-md heddin-lg">
            <a data-iconpos="notext" href="#panel" data-role="button" data-icon="flat-menu"></a>
            <h1 data-localize="title.pagetitle">SaNaVi</h1>
        </div>
    </div>

    <div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="loginmodal-container">
                <h1>Login to Your Account</h1>
                <br>
                <form>
                    <input type="text" name="loginid" id="loginid" placeholder="Your E-mail Address">
                    <input type="password" name="loginpass" id="loginpass" placeholder="Your Password">
                    <input type="button" id="login_comp" name="login" class="login loginmodal-button" value="Login">
                </form>

                <div class="login-help">
                    <a href="//toba-sanavi.azurewebsites.net/Register.html">Register</a>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
    <script src="js/infobox_packed.js"></script>
    <script type="text/javascript">
        var DB_markersArray = [];
        var search_markersArray = [];
        var Type_markersArray = [];
        var sounan_circleArray = [];

        var S_ship = []; //プロパティ用
        var T_ship = []; //プロパティ用
        var D_ship = []; //プロパティ用

        var Tpic = [];
        var Tflag = new Boolean(false); //接近検知 flag

        var Keihoulat; //警報音
        var Keihoulon;

        var emergency = []; //遭難用
        var Semergency = [];　
        var emergencysound = 0;
        var Eaudioflag = new Boolean(false); //接近検知 音 flag　

        var Slat = [];　 //遭難 Sounan
        var Slon = [];
        var Sship_name = [];
        var Scourse = [];
        var Sship_id = [];
        var Sflag = [];　 //遭難 Sounan

        var approach = []; //接近検知 approach
        var approachflag = new Boolean(false); //接近検知 flag
        var approach_emergencyflag = new Boolean(false); //接近検知 flag
        var Aaudioflag = new Boolean(false); //接近検知 音 flaｇ

        var points = []; //航跡表示線

        var scale = 0; //APIの大型船か、DBの小型船かの判別

        var login_id; //ログインid
        var login_check;
        var Lid = 111111111; //ログインid取得するやつ　初期値111111

        var ScountF = 0;
        var ScountT = 0;
        var EcountF = 0;
        var EcountT = 0;
        var positiondata;
        var timer1;
        var geocoder;
        var myLatlng;
        var latlngsea;
        var map;
        var poly = null;
        var latitude = 0;
        var longitude = 0;
        var direction = 0;
        var speed = 0;
        var accele_x = 0;
        var accele_y = 0;
        var accele_z = 0;
        var offline_time = "";
        var approach_distance = 0;

        var EcountT_100 = new Boolean(false); //100キロ圏内かどうか　
        var Musicflag = new Boolean(false); //接近検知 音 flag
        var Startflag = new Boolean(false); //スタートするかどうか
        var mapflag = new Boolean(false); //mapの現在位置のfalg
        var Connect_flag = new Boolean(true); //オンラインオフラインの処理
        var Approach_cancel_flag = new Boolean(true); //接近検知キャンセル
        var Approach_cancel_master_flag = new Boolean(false); //接近検知キャンセル
        var send_flag = new Boolean(true); //オフラインからオンラインに戻った時のフラグ
    </script>

    <script type="text/javascript">
        function BoxChecked() {
            $("#checklisttable label").addClass('ui-checkbox-on').removeClass('ui-checkbox-off');
            $("#checklisttable span.ui-icon").addClass('ui-icon-checkbox-on').removeClass('ui-icon-checkbox-off');
            $('input[type="checkbox"]').each(function() {
                $("#checklisttable input").each(function() {
                    $(this).prop('checked', false);
                });
                $("#checklisttable label").addClass('ui-checkbox-off').removeClass('ui-checkbox-on');
                $("#checklisttable span.ui-icon").addClass('ui-icon-checkbox-off').removeClass('ui-icon-checkbox-on');
            });


        }

        function AppChecked() {
            $("#checklisttable_app label").addClass('ui-checkbox-on').removeClass('ui-checkbox-off');
            $("#checklisttable_app span.ui-icon").addClass('ui-icon-checkbox-on').removeClass('ui-icon-checkbox-off');
            $('input[type="checkbox"]').each(function() {
                $("#checklisttable_app input").each(function() {
                    $(this).prop('checked', false);
                });
                $("#checklisttable_app label").addClass('ui-checkbox-off').removeClass('ui-checkbox-on');
                $("#checklisttable_app span.ui-icon").addClass('ui-icon-checkbox-off').removeClass('ui-icon-checkbox-on');
            });


        }

        /*-----------------------------------------------
         * プロパティを組む
         *-----------------------------------------------*/

        function Ship_data(_lat, _lon, _ship_name, _ship_id, _direction, _speed, _compass, _time, _ship_type) {
            this.lat = _lat;
            this.lon = _lon;
            this.ship_name = _ship_name;
            this.ship_id = _ship_id;
            this.direction = _direction;
            this.speed = _speed;
            this.compass = _compass;
            this.time = _time;
            this.ship_type = _ship_type;
        }


        $(function() {
            $("#response").html("Response Values");

            $("#button_search").click(function() {
                var data = {
                    ship_id: $("#value1").val()
                };

                mapflag = true;

                $.ajax({
                    type: 'post', // HTTPメソッド
                    //url  : 'http://toba-sanavi.azurewebsites.net/PHP/shipday.php',
                    url: '//toba-sanavi.azurewebsites.net/PHP/get_ship_name_id_Azure_demo.php',
                    data: data, // POSTするデータ
                    cache: false,
                    dataType: 'json',
                    success: function(data) { // 成功時の処理

                        deleteArray(Type_markersArray); //配列消去
                        deleteArray(search_markersArray);
                        deletepoints();

                        for (var i in data) {
                            S_ship[i] = new Ship_data(parseFloat(data[i].lat), parseFloat(data[i].lon), data[i].ship_name, data[i].ship_id, parseFloat(data[i].direction), data[i].speed, data[i].compass, data[i].time);

                            //dateオブジェクトの整形　ios関係のせいでややこしい
                            var timetmp = S_ship[i].time["date"];
                            var dateArr = timetmp.split(/[- :T\+]/);
                            var datetime = new Date(dateArr[0], dateArr[1] - 1, dateArr[2], dateArr[3], dateArr[4], dateArr[5]);

                            //9時間プラス
                            datetime.setMinutes(datetime.getMinutes());

                            //気が向いたら配列に
                            var yyyy = datetime.getFullYear();
                            var mm = datetime.getMonth() + 1;
                            var dd = datetime.getDate();
                            var Hours = datetime.getHours();
                            var Minutes = datetime.getMinutes();
                            var Seconds = datetime.getSeconds();

                            var markers = new google.maps.LatLng(S_ship[i].lat, S_ship[i].lon);

                            if (i == 1) {
                                Kposition = new google.maps.LatLng(S_ship[0].lat, S_ship[0].lon);
                            }

                            // ラインを引く座標の配列を作成
                            points.push(markers);

                            // 小数点の位置を2桁右に移動する（1234567.89にする）
                            S_ship[i].speed = S_ship[i].speed * 100;

                            // 四捨五入したあと、小数点の位置を元に戻す
                            S_ship[i].speed = Math.round(S_ship[i].speed) / 100;

                            if (i % 3 == 0) {

                                // マーカーを配列に格納する
                                var marker = new google.maps.Marker({
                                    position: markers,
                                    map: map,
                                    title: "Maybe you are here now.", //追加するならコンマ
                                    icon: {
                                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                        scale: 5, // 大きさ
                                        fillOpacity: 1, // 塗りつぶしの透過度
                                        fillColor: "#000000", // 塗りつぶしの色
                                        strokeColor: "#ffffff", // 線の色
                                        strokeWeight: 2, // 線の太さ
                                        rotation: S_ship[i].direction // 角度
                                    },

                                });

                                // var b64src = data[i].ship_picture;

                                var boxText = document.createElement("div");
                                boxText.innerHTML = "<div class='arrow_box'><br><div style='font-size: medium;'>　船名:" + S_ship[i].ship_name + "<br>" + 　"　速度:" + S_ship[i].speed +
                                    "km/h<br>　角度:" + S_ship[i].compass + "<br>" + "　日時:" + mm + "月" + dd + "日" + "<br>" + "　時間:" + Hours + "時" + Minutes + "分" + Seconds + "秒"　 + "</div>";

                                var myOptions = {
                                    content: boxText,
                                    disableAutoPan: false,
                                    maxWidth: 0,
                                    pixelOffset: new google.maps.Size(-100, -140),
                                    zIndex: null,
                                    boxStyle: {
                                        width: "210px"
                                    },
                                    closeBoxMargin: "10px 10px 2px 2px",
                                    closeBoxURL: "//www.google.com/intl/en_us/mapfiles/close.gif",
                                    infoBoxClearance: new google.maps.Size(1, 1),
                                    isHidden: false,
                                    pane: "floatPane",
                                    enableEventPropagation: false
                                };

                                var infowindow = new InfoBox(myOptions);

                                // マーカーがクリックされた時に情報ウィンドウを表示する処理
                                setMarker(marker, infowindow);

                                // マーカーを配列に保存する処理
                                search_markersArray.push(new mapData(marker, infowindow));

                            }


                        }

                        map.setCenter(Kposition);

                        if (poly) {
                            poly.setMap(null);
                        }

                        // ラインを作成
                        var polyLineOptions = {
                            path: points,
                            strokeWeight: 5,
                            strokeColor: "#0000ff",
                            strokeOpacity: "0.5"
                        };

                        // ラインを設定
                        poly = new google.maps.Polyline(polyLineOptions);
                        poly.setMap(map);

                        document.getElementById("return_map").style.display = "block";

                    }
                });

            });

        });
    </script>

    <script>
        $("#myTab1 a").click(function(e) {
            //e.preventDefault()
            e.stopPropagation();
            $(this).tab('show');
        });

        $(function() { //クッキーの設定
            if ($.cookie("sample")) {
                $("#login_now").text("船のid:" + $.cookie("sample") + "でログイン中です")
                Lid = $.cookie("sample");

            }

            $("#logout_start").click(function() {
                alert("Logout Complete");
                $.removeCookie("sample");
                location.href = "//toba-sanavi.azurewebsites.net/index_ios.html"
            })

            $("#register_start").click(function() {
                location.href = "//toba-sanavi.azurewebsites.net/Register.html"
            })

            $("#return_map").click(function() {
                mapflag = false;
                map.setCenter(myLatlng);
                document.getElementById("return_map").style.display = "none";
            })

            $("#login_comp").click(function() {

                var data = {
                    E_mail: $("#loginid").val(),
                    password: $("#loginpass").val()
                };

                $.ajax({
                    type: 'post', // HTTPメソッド
                    url: '//toba-sanavi.azurewebsites.net/PHP/get_ship_id_login_Azure.php',
                    data: data, // POSTするデータ
                    cache: false,
                    dataType: 'json',
                    success: function(data) { // 成功時の処理
                        login_check = parseFloat(data[0].login);
                        login_id = parseFloat(data[0].ship_id);

                        if (login_check == 0) {
                            alert("Login Complete ");
                            $.cookie("sample", login_id, {
                                expires: 30
                            });
                            location.href = "//toba-sanavi.azurewebsites.net/index_ios.html"
                        } else {
                            alert("Login failed");
                        }
                    }
                });

            })
        })


        //timer1 = setInterval(function() { // キャンセルボタン用
        setInterval(function() {
            if (Startflag == true) {

                if (Lid != 111111111) {

                    //オンライン、オフラインの判定 ネイティブアプリ使用時はコメントアウト
                    if (navigator.onLine === true) {
                        if (Connect_flag == false) {
                            //window.webkit.messageHandlers.callbackHandler.postMessage("Reconnection");
                            location.href = 'Reconnection://foobar/';
                            Connect_flag = true;
                        }
                    } else if (navigator.onLine === false) {
                        Connect_flag = false;
                        send_flag = false;
                            location.href = 'jsnoty://foobar/,'+latitude + "," + longitude + "," + direction + "," + speed + "," + offline_time + "," + accele_x + "," + accele_y + "," + accele_z;
                        //window.webkit.messageHandlers.callbackHandler.postMessage();
                    } else {
                        console.log("ネットワーク未検出");
                    }

                    if (send_flag == true) {

                        $.ajax({
                            type: 'post', // HTTPメソッド
                            url: '//toba-sanavi.azurewebsites.net/PHP/sending_information_emergency_Azure.php', // POSTするURL
                            data: positiondata, // POSTするデータ
                            dataType: 'json', // レスポンスのデータ型
                        });

                        if (Approach_cancel_master_flag == false) {
                            //approach(); //アプローチを先に　エマージェンシーを後に
                        }

                        //emergency();
                    }

                }

                /*-----------------------------------------------
                 * DBから自分を中心とした100キロ圏内の船を引き出す
                 *-----------------------------------------------*/
                 if(Connect_flag == true){
                $.ajax({
                    type: 'post', // HTTPメソッド
                    url: '//toba-sanavi.azurewebsites.net/PHP/getting_data_latlon_Azure.php',
                    data: positiondata, // POSTするデータ
                    cache: false,
                    dataType: 'json',
                    success: function(data) { // 成功時の処理
                        //alert(JSON.stringify(data));
                        // マーカーの配列を空にする
                        deleteArrayDB(DB_markersArray);


                        for (var i in data) {
                            D_ship[i] = new Ship_data(parseFloat(data[i].lat), parseFloat(data[i].lon), data[i].ship_name, data[i].ship_id, parseFloat(data[i].direction), data[i].speed, data[i].compass, data[i].time, data[i].ship_type);

                            //dateオブジェクトの整形　ios関係のせいでややこしい
                            var timetmp = D_ship[i].time["date"];
                            var dateArr = timetmp.split(/[- :T\+]/);
                            var datetime = new Date(dateArr[0], dateArr[1] - 1, dateArr[2], dateArr[3], dateArr[4], dateArr[5]);

                            //var datetime = new Date(timetmp.replace(/-/g,"/"));

                            //9時間プラス
                            datetime.setMinutes(datetime.getMinutes());

                            //気が向いたら配列に
                            var yyyy = datetime.getFullYear();
                            var mm = datetime.getMonth() + 1;
                            var dd = datetime.getDate();
                            var Hours = datetime.getHours();
                            var Minutes = datetime.getMinutes();
                            var Seconds = datetime.getSeconds();

                            //alert(D_ship[i].compass);

                            //小数点の位置を2桁右に移動する（1234567.89にする）
                            D_ship[i].speed = D_ship[i].speed * 100;

                            //四捨五入したあと、小数点の位置を元に戻す
                            D_ship[i].speed = Math.round(D_ship[i].speed) / 100;

                            var markers = new google.maps.LatLng(D_ship[i].lat, D_ship[i].lon);

                            scale = 5;

                            // マーカーを配列に格納する
                            var marker = new google.maps.Marker({
                                position: markers,
                                map: map,
                                title: "Maybe you are here now.",
                                icon: {
                                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                    scale: scale, // 大きさ
                                    fillOpacity: 1, // 塗りつぶしの透過度
                                    fillColor: D_ship[i].ship_type, // 塗りつぶしの色
                                    strokeColor: "#ffffff", // 線の色
                                    strokeWeight: 2, // 線の太さ
                                    rotation: D_ship[i].direction // 角度
                                },

                            });

                            //var b64src = data[i].ship_picture;
                            var boxText = document.createElement("div");
                            boxText.innerHTML = "<div class='arrow_box'><br><div style='font-size: medium;'>　船名:" + D_ship[i].ship_name + "<br>" + 　"　速度:" + D_ship[i].speed +
                                "km/h<br>　角度:" + D_ship[i].compass + "<br>" + "　日時:" + mm + "月" + dd + "日" + "<br>" + "　時間:" + Hours + "時" + Minutes + "分" + Seconds + "秒"　 + "</div>";

                            // 情報ウィンドウを作成する
                            var myOptions = {
                                content: boxText,
                                disableAutoPan: false,
                                maxWidth: 0,
                                pixelOffset: new google.maps.Size(-100, -140),
                                zIndex: null,
                                boxStyle: {
                                    width: "210px"
                                },
                                closeBoxMargin: "10px 10px 2px 2px",
                                closeBoxURL: "//www.google.com/intl/en_us/mapfiles/close.gif",
                                infoBoxClearance: new google.maps.Size(1, 1),
                                isHidden: false,
                                pane: "floatPane",
                                enableEventPropagation: false
                            };

                            var infowindow = new InfoBox(myOptions);

                            // マーカーがクリックされた時に情報ウィンドウを表示する処理
                            setMarker(marker, infowindow);

                            // マーカーを配列に保存する処理
                            DB_markersArray.push(new mapData(marker, infowindow));
                            //DB_markersArray.push(marker);

                        }
                    }
                });

                if (DB_markersArray) {
                    for (var i = 0; i < DB_markersArray.length; i++) {
                        eraseArray(DB_markersArray[i]);

                    }
                }

                // マーカーの配列を表示する
                if (DB_markersArray) {
                    for (var i = 0; i < DB_markersArray.length; i++) {
                        drawArray(DB_markersArray[i]);
                    }
                }
              }

            }
            console.log("定期実行");
        }, 3000);

        //swiftから実行する関数
        function BackgroundHandler(lat, lon, direction, speed, time, x, y, z) {
          　console.log("データ受け取り");
            var lat_split = lat.split(",");
            var lon_split = lon.split(",");
            var direction_split = direction.split(",");
            var speed_split = speed.split(",");
            var time_split = time.split(",");
            var accele_x_split = x.split(",");
            var accele_y_split = y.split(",");
            var accele_z_split = z.split(",");

            for (var i = 0; i < accele_x_split.length; i++) {
              console.log(lat_split[i]);
              console.log(accele_x_split[i]);
              console.log(accele_z_split);
              console.log(time_split);
            }

            var B_positiondata = {
                ship_id: Lid,
                lat: lat_split,
                lon: lon_split,
                direction: direction_split,
                speed: speed_split,
                time: time_split,
                accele_x: accele_x_split,
                accele_y: accele_y_split,
                accele_z: accele_z_split
            };

            $.ajax({
                type: 'post', // HTTPメソッド
                url: '//toba-sanavi.azurewebsites.net/PHP/testback.php',
                data: B_positiondata, // POSTするデータ
                cache: false,
                dataType: 'json',
                success: function(data) { // 成功時の処理
                    console.log("insert終了")
                    send_flag = true;
                    for (var i in data) {
                      console.log(parseFloat(data[i].lat1));
                      console.log(parseFloat(data[i].lat2));
                      console.log(parseFloat(data[i].lat3));
                      console.log(parseFloat(data[i].lat4));
                      console.log(parseFloat(data[i].lat5));
                      console.log(parseFloat(data[i].lat6));
                      console.log(parseFloat(data[i].lat7));
                      console.log(parseFloat(data[i].lat8));
                    }
                }

            });
        }

        // マップのオプション
        var myOptions = {
            zoom: 17,
            mapTypeIds: google.maps.MapTypeId.ROADMAP
        }

        // マップの表示
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        //ジオコーダー
        geocoder = new google.maps.Geocoder();
        // 位置情報取得のオプション
        var position_options = {
            enableHighAccuracy: true
        };

        // 現在位置情報を取得
        navigator.geolocation.watchPosition(monitor, null, position_options);


        // 位置情報取得成功時の処理
        function monitor(position) {

            myLatlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

            if (mapflag == false) {
                map.setCenter(myLatlng);
            }


            // 緯度
            latitude = position.coords.latitude;
            // 経度
            longitude = position.coords.longitude;

            direction = position.coords.heading;

            speed = position.coords.speed;

            // 1桁の数字を0埋めで2桁にする
            var toDoubleDigits = function(num) {
                num += "";
                if (num.length === 1) {
                    num = "0" + num;
                }
                return num;
            };

            var DD = new Date();
            DD.setMinutes(DD.getMinutes());
            var yyyy = DD.getFullYear();
            var mm = toDoubleDigits(DD.getMonth() + 1);
            var dd = toDoubleDigits(DD.getDate());
            var Hours = DD.getHours();
            var Minutes = toDoubleDigits(DD.getMinutes());
            var Seconds = toDoubleDigits(DD.getSeconds());

            offline_time = yyyy + "/" + mm + "/" + dd + " " + Hours + ":" + Minutes + ":" + Seconds;

            window.addEventListener("devicemotion", function(event) {
                accele_x = event.accelerationIncludingGravity.x;
                accele_y = event.accelerationIncludingGravity.y;
                accele_z = event.accelerationIncludingGravity.z;
            });

            positiondata = {
                ship_id: Lid,
                lat: latitude,
                lon: longitude,
                direction: direction,
                speed: speed,
                accele_x: accele_x,
                accele_y: accele_y,
                accele_z: accele_z
            };
            //$("#login_now").text(latitude + '\n' + longitude + '\n' + direction + '\n' + speed + '\n' + offline_time)

        }

        $(window).load(function() {
                Startflag = true;
                audio3.load();
                mapResize();
        });


        function mapResize() {
            var divObj = document.getElementById("map_canvas");
            google.maps.event.trigger(map_canvas, "resize");
        }




        /*-----------------------------------------------
         * 遭難検知
         *-----------------------------------------------*/

        function emergency() {
            EcountT = 0;
            EcountF = 0;


            var data = {
                ship_id: Lid
            }; //id取得


            $.ajax({
                type: 'post', // HTTPメソッド
                url: '//toba-sanavi.azurewebsites.net/PHP/getting_data_emergency_Azure.php',
                data: data, // POSTするデータ
                cache: false,
                dataType: 'json',
                success: function(data) { // 成功時の処理
                    //dataを見やすいように加工する

                    for (var i in data) {
                        emergency[i] = parseFloat(data[i].emergency);
                        if (emergency[i] == 0) {
                            EcountT++

                        } else {
                            EcountF++
                        }
                    }
                    //  alert("遭難しました");
                    if (EcountT != 0) {

                        //今の状況やとむり　もう一戸フラグ

                        var data2 = {
                            ship_id: Lid
                        }; //id取得

                        $.ajax({
                            type: 'post', // HTTPメソッド
                            url: '//toba-sanavi.azurewebsites.net/PHP/emergency_sounan_Azure.php',
                            data: data2, // POSTするデータ
                            cache: false,
                            dataType: 'json',
                            success: function(data2) { // 成功時の処理
                                // マーカーの配列を空にする
                                if (sounan_circleArray) {
                                    for (i in sounan_circleArray) {
                                        sounan_circleArray[i].setMap(null);
                                    }
                                    sounan_circleArray.length = 0;
                                }

                                for (var i in data2) {
                                    Slat[i] = parseFloat(data2[i].lat);
                                    Slon[i] = parseFloat(data2[i].lon);
                                    Semergency[i] = parseFloat(data2[i].emergency);
                                    Sflag[i] = parseFloat(data2[i].flag);


                                    if (Sflag[i] == 0) {
                                        //Eaudioflag = true;
                                        EcountT_100 = true;
                                        //alert(EcountT_100);
                                    }


                                    var markers = new google.maps.LatLng(Slat[i], Slon[i]);


                                    // マーカーを配列に格納する
                                    var marker = new google.maps.Marker({
                                        position: markers,
                                        map: map,
                                        title: "Maybe you are here now.", //追加するならコンマ
                                        zIndex: 1,
                                        icon: {
                                            path: google.maps.SymbolPath.CIRCLE,
                                            // scale: Semergency[i]*2, // 大きさ
                                            scale: 100, // 大きさ
                                            fillOpacity: 0.6, // 塗りつぶしの透過度
                                            fillColor: "#FF0000", // 塗りつぶしの色
                                            strokeColor: "#ffffff", // 線の色
                                            strokeWeight: 2, // 線の太さ
                                        },

                                    });


                                    sounan_circleArray.push(marker);
                                }
                            }
                        });

                        // マーカーの配列を表示する
                        if (sounan_circleArray) {
                            for (i in sounan_circleArray) {
                                sounan_circleArray[i].setMap(map);
                            }
                        }

                        if (EcountT_100 == true) {

                            Eaudioflag = true;
                            if (approach_emergencyflag == true) { //接近してるとき　遭難してるとき
                                document.getElementById("approach").style.display = "none";
                                document.getElementById("emergency").style.display = "none";
                                document.getElementById("approach_emergency").style.display = "block";
                            } else { //接近してない　遭難してる false
                                document.getElementById("approach").style.display = "none";
                                document.getElementById("approach_emergency").style.display = "none";
                                document.getElementById("emergency").style.display = "block";
                            }

                        }
                    } else {

                        if (approach_emergencyflag == true) { //接近してる　遭難してない
                            document.getElementById("emergency").style.display = "none";
                            document.getElementById("approach").style.display = "block";
                            document.getElementById("approach_emergency").style.display = "none";
                            //alert("接近");
                            //document.getElementById("approach").style.display="none";
                        } else { //接近してない　遭難してない false
                            document.getElementById("approach").style.display = "none";
                            document.getElementById("approach_emergency").style.display = "none";
                            document.getElementById("emergency").style.display = "none";
                        }
                        //  alert("遭難していません");

                        // マーカーの配列を空にする
                        if (sounan_circleArray) {
                            Eaudioflag = false;
                            for (i in sounan_circleArray) {
                                sounan_circleArray[i].setMap(null);
                            }
                            sounan_circleArray.length = 0;
                        }

                        EcountT_100 = false;

                    }

                }
            });


            if (Aaudioflag == true && Musicflag == false || Eaudioflag == true && Musicflag == false) {
                audio3.play();
                Musicflag = true;
            }

            if (Aaudioflag == false && Eaudioflag == false) {
                audio3.pause();
                Musicflag = false;
            }


        }
        /*-----------------------------------------------
         * 接近検知
         *-----------------------------------------------*/
        function approach() {
            ScountT = 0;
            ScountF = 0;

            var data = {
                ship_id: Lid,
                //distance: approach_distance
            }; //id取得

            $.ajax({
                type: 'post', // HTTPメソッド
                url: '//toba-sanavi.azurewebsites.net/PHP/getting_data_within20m_Azure.php',
                //url: '//toba-sanavi.azurewebsites.net/PHP/getting_data_approach_Azure.php',
                data: data, // POSTするデータ
                cache: false,
                dataType: 'json',
                success: function(data) { // 成功時の処理
                    // 返却されたテキストをjavascriptのオブジェクトに変換
                    // dataを見やすいように加工する

                    for (var i in data) {
                        approach[i] = parseFloat(data[i].approach);
                        if (approach[i] == 0) {
                            //接近中
                            ScountT++;
                        } else if (approach[i] == 1) {
                            ScountF++;
                        }

                    }

                    if (ScountT != 0 && Approach_cancel_master_flag == false) {
                        //無理やり表示してる
                        document.getElementById("approach").style.display = "block";
                        //audio3.load();
                        audio3.play();
                        Aaudioflag = true;
                        approachflag = true;
                        approach_emergencyflag = true;
                    } else {
                        //無理やり表示してる
                        document.getElementById("approach").style.display = "none";
                        //alert("muri");
                        audio3.pause();　
                        Aaudioflag = false;
                        approachflag = false;
                        approach_emergencyflag = false;
                    }

                }
            });


        }



        /*-----------------------------------------------
         * マーカー管理用
         *-----------------------------------------------*/
        function mapData(_marker, _infoWindow) {
            this.marker = _marker;
            this.infoWindow = _infoWindow;
        }

        /*-----------------------------------------------
         * マーカーをセットする処理
         *-----------------------------------------------*/
        function setMarker(marker, infoWindow) {
            google.maps.event.addListener(marker, 'click', function(event) {
                infoWindow.open(marker.getMap(), marker);
            });
        }

        /*-----------------------------------------------
         * マーカーを表示する処理
         *-----------------------------------------------*/
        function drawArray(arrayData) {
            for (var i = 0; i < arrayData.length; i++) {
                arrayData[i].marker.setVisible(true);
            }
        }

        /*-----------------------------------------------
         * マーカーと吹き出しを非表示にする処理
         *-----------------------------------------------*/
        function eraseArray(arrayData) {
            for (var i = 0; i < arrayData.length; i++) {
                arrayData[i].marker.setVisible(false);
                arrayData[i].infoWindow.close();
            }
        }

        /*-----------------------------------------------
         * 配列を削除する処理
         *-----------------------------------------------*/
        function deleteArray(arrayData) {
            for (var i = 0; i < arrayData.length; i++) {
                arrayData[i].marker.setMap(null);
                arrayData[i].infoWindow.setMap(null);
            }
            arrayData.length = 0; // 配列を空にしておく
            return arrayData;
        }

        /*-----------------------------------------------
         * DBmarkersの配列を削除する処理
         *-----------------------------------------------*/
        　
        function deleteArrayDB(arrayData) {
            for (var i = 0; i < arrayData.length; i++) {
                arrayData[i].marker.setMap(null);
            }
            arrayData.length = 0;
            return arrayData;
        }

        /*-----------------------------------------------
         * points配列の初期化
         *-----------------------------------------------*/

        function deletepoints() {
            points = [];
        }

        /*-----------------------------------------------
         * polylineの初期化
         *-----------------------------------------------*/

        function deletepoly() {
            points = [];
            if (poly) {
                poly.setMap(null);
            }
        }

        /*-----------------------------------------------
         * チェックボックスの表示、オンオフの切り替え、船の種類表示
         *-----------------------------------------------*/
        function chkdisp(obj, id) {

            if (obj == true) {
                var str = id.toString();
                var data = {
                    ship_type: str
                };
                // var json = JSON.stringify(str) // JavaScript から JSON

                $.ajax({
                    type: 'post', // HTTPメソッド
                    url: '//toba-sanavi.azurewebsites.net/PHP/getting_ship_type_Azure.php', // POSTするURL
                    data: data, // POSTするデータ
                    cache: false,
                    dataType: 'json',
                    success: function(data) { // 成功時の処理
                        //alert(JSON.stringify(data));

                        //Tflag = true;
                        deleteArray(search_markersArray);
                        deleteArray(Type_markersArray); //配列消去
                        deleteArray(DB_markersArray);
                        deletepoly();

                        for (var i in data) {
                            T_ship[i] = new Ship_data(parseFloat(data[i].lat), parseFloat(data[i].lon), data[i].ship_name, data[i].ship_id, parseFloat(data[i].direction), data[i].speed, data[i].compass, data[i].time, data[i].ship_type);

                            //dateオブジェクトの整形　ios関係のせいでややこしい
                            var timetmp = T_ship[i].time["date"];
                            var dateArr = timetmp.split(/[- :T\+]/);
                            var datetime = new Date(dateArr[0], dateArr[1] - 1, dateArr[2], dateArr[3], dateArr[4], dateArr[5]);


                            //9時間プラス
                            datetime.setMinutes(datetime.getMinutes());

                            //気が向いたら配列に
                            var yyyy = datetime.getFullYear();
                            var mm = datetime.getMonth() + 1;
                            var dd = datetime.getDate();
                            var Hours = datetime.getHours();
                            var Minutes = datetime.getMinutes();
                            var Seconds = datetime.getSeconds();

                            var markers = new google.maps.LatLng(Tlat[i], Tlon[i]);

                            //小数点の位置を2桁右に移動する（1234567.89にする）
                            T_ship[i].speed = T_ship[i].speed * 100;

                            //四捨五入したあと、小数点の位置を元に戻す
                            T_ship[i].speed = Math.round(T_ship[i].speed) / 100;


                            // マーカーを配列に格納する
                            var marker = new google.maps.Marker({
                                position: markers,
                                map: map,
                                title: "Maybe you are here now.", //追加するならコンマ
                                icon: {
                                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                    scale: 5, // 大きさ
                                    fillOpacity: 1, // 塗りつぶしの透過度
                                    fillColor: "#A0522D", // 塗りつぶしの色
                                    strokeColor: "#ffffff", // 線の色
                                    strokeWeight: 2, // 線の太さ
                                    rotation: 19 // 角度
                                },

                            });

                            // 情報ウィンドウを作成する
                            //var b64src = data[i].ship_picture;

                            var boxText = document.createElement("div");
                            boxText.innerHTML = "<div class='arrow_box'><br><div style='font-size: medium;'>　船名:" + T_ship[i].ship_name + "<br>" + "　速度:" + T_ship[i].speed +
                                "km/h<br>　角度:" + T_ship[i].compass + "<br>" + "　日時:" + mm + "月" + dd + "日" + "<br>" + "　時間:" + Hours + "時" + Minutes + "分" + Seconds + "秒"　 + "</div>";

                            var myOptions = {
                                content: boxText,
                                disableAutoPan: false,
                                maxWidth: 0,
                                pixelOffset: new google.maps.Size(-100, -140),
                                zIndex: null,
                                boxStyle: {
                                    width: "210px"
                                },
                                closeBoxMargin: "10px 10px 2px 2px",
                                closeBoxURL: "//www.google.com/intl/en_us/mapfiles/close.gif",
                                infoBoxClearance: new google.maps.Size(1, 1),
                                isHidden: false,
                                pane: "floatPane",
                                enableEventPropagation: false
                            };

                            var infowindow = new InfoBox(myOptions);

                            // マーカーがクリックされた時に情報ウィンドウを表示する処理
                            setMarker(marker, infowindow);

                            // マーカーを配列に保存する処理
                            Type_markersArray.push(new mapData(marker, infowindow));


                        }


                    }
                });

            } else {

                deleteArray(Type_markersArray); //配列消去
                deleteArray(DB_markersArray);

            }
        }

        // チェックボックスが true の時の処理 ----------------------------
        function Approachclick() {
            //var val = $('#cb_gyosen').is(':checked'); でも判定できる

            if (jQuery('#cb_approach').prop('checked') == true) {
                BoxChecked();
                $("#cb_approach").prop('checked', true);

                //off時の処理
                Approach_cancel_master_flag = true;
                document.getElementById("approach").style.display = "none";
                audio3.pause();　
                Aaudioflag = false;
                approachflag = false;
                approach_emergencyflag = false;


            } else {
                Approach_cancel_master_flag = false;
                BoxChecked();
            }

        }

        function Gclick() {
            //var val = $('#cb_gyosen').is(':checked'); でも判定できる

            if (jQuery('#cb_gyosen').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_gyosen").prop('checked', true);
                chkdisp(true, '漁船');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, '漁船');
            }

        }

        function RYOclick() {

            if (jQuery('#cb_ryokyaku').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_ryokyaku").prop('checked', true);
                chkdisp(true, '旅客船');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, '旅客船');
            }

        }

        function KAclick() {

            if (jQuery('#cb_kamotu').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_kamotu").prop('checked', true);
                chkdisp(true, '貨物船');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, '貨物船');
            }

        }

        function KOclick() {

            if (jQuery('#cb_kousoku').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_kousoku").prop('checked', true);
                chkdisp(true, '高速船');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, '高速船');
            }

        }

        function TANclick() {

            if (jQuery('#cb_tannka').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_tannka").prop('checked', true);
                chkdisp(true, 'タンカー');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, 'タンカー');
            }

        }

        function REclick() {

            if (jQuery('#cb_rezya').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_rezya").prop('checked', true);
                chkdisp(true, 'レジャー');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, 'レジャー');
            }

        }

        function TAGclick() {


            if (jQuery('#cb_tag').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_tag").prop('checked', true);
                chkdisp(true, 'タグ、パイロット船');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, 'タグ、パイロット船');
            }

        }

        function Yclick() {

            if (jQuery('#cb_others').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_others").prop('checked', true);
                chkdisp(true, 'ヨット、その他');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, 'ヨット、その他');

            }

        }

        function Mclick() {

            if (jQuery('#cb_minyuryoku').prop('checked') == true) {
                Startflag = false;
                BoxChecked();
                $("#cb_minyuryoku").prop('checked', true);
                chkdisp(true, '未入力');
            } else {
                Startflag = true;
                BoxChecked();
                chkdisp(false, '未入力');

            }

        }






        /*-----------------------------------------------
         * ラジオボタンを押したときの処理
         *-----------------------------------------------*/
        $(function() {

            $('#radio-btn-group input[type=radio]').change(function() {
                //console.log(this.value);
                switch (this.value) {
                    case "display":
                        drawArray(markersArray);
                        break;
                    case "undisplay":
                        eraseArray(markersArray);
                        break;

                    case "delete":
                        deleteArray(markersArray);
                        break;
                    default:

                }
            });

        })
    </script>



    <div id="approach" class="content" style="display:none">
        <div id="footerFloatingMenu">
            <a href="#">
                <img src="img/keihou1.png">
            </a>
        </div>
    </div>

    <div id="emergency" class="content" style="display:none">
        <div id="footerFloatingMenu">
            <a href="#">
                <img src="img/keihou2.png">
            </a>
        </div>
    </div>

    <div id="approach_emergency" class="content" style="display:none">
        <div id="footerFloatingMenu">
            <a href="#">
                <img src="img/keihou3.png">
            </a>
        </div>
    </div>

    <div class="modal" id="div-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">SaNaViへようこそ！</h4>
                </div>
                <div class="modal-body">
                    <p>『SaNaVi』はスマートフォンを用いて誰でも簡単に小型船の事故対策ができるシステムです！
                        <br>利用するには「利用規約」に同意する必要があります。</p>

                </div>
                <div class="modal-footer">
                    <button id="buttonaudio" type="button" class="modern-btn start btn-primary" data-dismiss="modal">利用規約に同意する</button>
                    <button data-toggle="modal" data-target="#myModal2" class="modern-btn start btn-primary">利用規約を確認する</button>
                </div>
            </div>
        </div>
    </div>



    <div id="myModal2" class="modal">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">規約･免責事項</h4>
                </div>
                <div class="modal-body">
                    <p>『SaNaVi』のコンテンツサービスをご利用いただくには本規約に従っていただきます。
                        <br> また、サービスを利用することによって、本規約の内容を承諾いただいたものとみなします。
                        <br> 本規約の内容は必要に応じ予告なく改変することがあります。
                        <br>
                    </p>
                    <p>第1条 内容の保証
                        <br>内容の更新や変更、または天災・災害及びシステムの故障等で、止も得ない事由により掲載を一時的に中断する場合があります。
                        <br> 本サービスはご利用の皆様に対して事前にお知らせをすることなく、サービスの追加、変更、更新を行います。
                        <br> 同様に、サービスの運営上そのシステムの変更が必要であると判断した場合には、事前にお知らせをすることなく必要な変更を行うことがあります
                        <br>
                    </p>
                    <p>第2条　損害に対する責務
                        <br>本サービスから得られた情報にもとづいて生じた損害・障害・不利益等に対する責任は一切負うことはございません。
                        <br>本サービスの利用者は自己責任で本サービス上の情報やサービスを利用・検討するものとします。
                        <br> 『SaNaVi』はこれらの情報やサービス提供が原因で発生した損害すべてに対し、いかなる責任をも負わないものとし、一切の損害賠償義務は無いものとします。
                    </p>
                    <p>第3条　収集した情報の二次利用
                        <br>本サービスで収集した情報について、本サービスの運営のために使用・公開されます。
                        <br>本サービス上で公開される情報は船舶位置・船名などの船舶情報（個人名などの個人に関する登録情報を除く）を原則としますが、船舶の安全運航を目的として必要と判断した場合はこの限りではありません。
                        <br>本サービス上で公開される情報と同等の情報を、他の船舶運航に関するサービスに提供することがあります。
                    </p>







                </div>
                <div class="modal-footer">
                    <button type="button" class="modern-btn start btn-primary" data-dismiss="modal">閉じる</button>

                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

    <audio id="audio3" src="sound/meka_ge_keihou05.mp3" preload="auto"></audio>
</body>


<!-- <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'> -->
<!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
<!--[if lt IE 9]>
	<script src="js/html5shiv.js"></script>
	<script src="js/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.mobile.flatui.min.css" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/img.min.css" />
<link rel="stylesheet" href="css/introjs.min.css" />
<link href="//fonts.googleapis.com/css?family=Open+Sans:400,300,600,800,700,400italic,600italic,700italic,800italic,300italic" rel="stylesheet" type="text/css">

</html>
